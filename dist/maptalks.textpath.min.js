/*!
 * maptalks.textpath v0.1.0
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@>=0.40.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,h){"use strict";function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):function(t,e){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i],o=Object.getOwnPropertyDescriptor(e,r);o&&o.configurable&&void 0===t[r]&&Object.defineProperty(t,r,o)}}(t,e))}!function(){function g(t,e,n,i){var r=n-t,o=i-e;return Math.sqrt(r*r+o*o)}CanvasRenderingContext2D.prototype.textOverflow="",CanvasRenderingContext2D.prototype.textJustify=!1,CanvasRenderingContext2D.prototype.textStrokeMin=0;var e=[],t=CanvasRenderingContext2D.prototype.save;CanvasRenderingContext2D.prototype.save=function(){e.push({textOverflow:this.textOverflow,textJustify:this.textJustify,textStrokeMin:this.textStrokeMin}),t.call(this)};var n=CanvasRenderingContext2D.prototype.restore;CanvasRenderingContext2D.prototype.restore=function(){n.call(this);var t=e.pop();this.textOverflow=t.textOverflow,this.textJustify=t.textJustify,this.textStrokeMin=t.textStrokeMin},CanvasRenderingContext2D.prototype.textPath=function(t,r){var o,s=0,a=2;function e(t){if(!o||s+o<t)for(;a<r.length&&(o=g(r[a-2],r[a-1],r[a],r[a+1]),!(t<s+o))&&!((a+=2)>=r.length);)s+=o;var e,n,i=t-s;return a>=r.length&&(a=r.length-2),i?(e=r[a-2]+(r[a]-r[a-2])*i/o,n=r[a-1]+(r[a+1]-r[a-1])*i/o):(e=r[a-2],n=r[a-1]),[e,n,Math.atan2(r[a+1]-r[a-1],r[a]-r[a-2])]}for(var n=.25*this.measureText(" ").width,i=0,l=2;l<r.length;l+=2)i+=g(r[l-2],r[l-1],r[l],r[l+1]);if(!(i<this.minWidth)){var h=t.split(" ").length-1;if("visible"!=this.textOverflow&&i<this.measureText(t).width+(t.length-1+h)*n){for(var f="ellipsis"==this.textOverflow?"\u2026":this.textOverflow||"",p=f.length-1;" "===t[t.length-1]&&h--,(t=t.slice(0,-1))&&i<this.measureText(t+f).width+(t.length+p+h)*n;);t+=f}var x=0;switch(this.textJustify||this.textAlign){case!0:case"center":case"end":case"right":this.textJustify?(x=0,n=(i-this.measureText(t).width)/(t.length-1+h)):(x=i-this.measureText(t).width-(t.length+h)*n,"center"==this.textAlign&&(x/=2))}for(var u=0;u<t.length;u++){var c=t[u],y=this.measureText(c).width,v=e(x+y/2);this.save(),this.textAlign="center",this.translate(v[0],v[1]),this.rotate(v[2]),.1<this.lineWidth&&this.strokeText(c,0,0),this.fillText(c,0,0),this.restore(),x+=y+n*(" "==c?2:1)}}}}();var f=h.LineString.prototype._paintOn,e=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,t.apply(this,arguments))}return n(e,t),e.prototype._paintOn=function(t,e,n,i,r){var o=this.getSymbol();if(o&&o.textPathSize){!function(t){for(var e,n,i=0;i<t.length-1;)e=t[i],n=t[i+1],Math.abs(e.x-n.x)<1e-6&&Math.abs(e.y-n.y)<1e-6?t.splice(i+1,1):i++}(e);var s=this.getMap().getScale(),a=parseInt(o.textPathSize/s);if(a<3||1e3<a)return;var l=(a+="px")+" "+this.options.fontFamily;this._paintPolylineTextPath(t,e,this.options.textName,l,this.options.symbol.lineWidth,n)}else f.apply(this,arguments)},e.prototype._paintPolylineTextPath=function(t,e,n,i,r,o){t.font=i,t.strokeStyle="rgba(0,0,0,0)",t.lineWidth=0,t.globalAlpha=o,t.textAlign="center",t.textBaseline="middle",t.textOverflow="visible",t.textJustify=!0;for(var s=[],a=e.length,l=0;l<a;l++)s.push(e[l].x),s.push(e[l].y);t.beginPath(),t.moveTo(s[0],s[1]),t.textPath(n,s),h.Canvas._stroke(t,o)},e}(h.LineString);e.mergeOptions({fontSize:"48px",fontFamily:"Arial",textJustify:!0,textOverflow:"visible",textBaseline:"middle",textStrokeMin:5}),e.registerJSONType("TextPath"),t.TextPath=e,t.default=e,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.textpath v0.1.0, requires maptalks@>=0.40.0.")});