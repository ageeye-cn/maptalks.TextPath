/*!
 * maptalks.textpath v0.1.0
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@>=0.40.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("maptalks")):"function"==typeof define&&define.amd?define(["maptalks"],e):e(t.maptalks)}(this,function(l){"use strict";!function(){function d(t,e,i,n){var s=i-t,a=n-e;return Math.sqrt(s*s+a*a)}CanvasRenderingContext2D.prototype.textOverflow="",CanvasRenderingContext2D.prototype.textJustify=!1,CanvasRenderingContext2D.prototype.textStrokeMin=0;var e=[],t=CanvasRenderingContext2D.prototype.save;CanvasRenderingContext2D.prototype.save=function(){e.push({textOverflow:this.textOverflow,textJustify:this.textJustify,textStrokeMin:this.textStrokeMin}),t.call(this)};var i=CanvasRenderingContext2D.prototype.restore;CanvasRenderingContext2D.prototype.restore=function(){i.call(this);var t=e.pop();this.textOverflow=t.textOverflow,this.textJustify=t.textJustify,this.textStrokeMin=t.textStrokeMin},CanvasRenderingContext2D.prototype.textPath=function(t,s){var a,r=0,o=2;function e(t){if(!a||r+a<t)for(;o<s.length&&(a=d(s[o-2],s[o-1],s[o],s[o+1]),!(t<r+a))&&!((o+=2)>=s.length);)r+=a;var e,i,n=t-r;return o>=s.length&&(o=s.length-2),n?(e=s[o-2]+(s[o]-s[o-2])*n/a,i=s[o-1]+(s[o+1]-s[o-1])*n/a):(e=s[o-2],i=s[o-1]),[e,i,Math.atan2(s[o+1]-s[o-1],s[o]-s[o-2])]}for(var i=.25*this.measureText(" ").width,n=0,h=2;h<s.length;h+=2)n+=d(s[h-2],s[h-1],s[h],s[h+1]);if(!(n<this.minWidth)){var l=t.split(" ").length-1;if("visible"!=this.textOverflow&&n<this.measureText(t).width+(t.length-1+l)*i){for(var x="ellipsis"==this.textOverflow?"\u2026":this.textOverflow||"",f=x.length-1;" "===t[t.length-1]&&l--,(t=t.slice(0,-1))&&n<this.measureText(t+x).width+(t.length+f+l)*i;);t+=x}var p=0;switch(this.textJustify||this.textAlign){case!0:case"center":case"end":case"right":this.textJustify?(p=0,i=(n-this.measureText(t).width)/(t.length-1+l)):(p=n-this.measureText(t).width-(t.length+l)*i,"center"==this.textAlign&&(p/=2))}for(var v=0;v<t.length;v++){var u=t[v],g=this.measureText(u).width,c=e(p+g/2);this.save(),this.textAlign="center",this.translate(c[0],c[1]),this.rotate(c[2]),.1<this.lineWidth&&this.strokeText(u,0,0),this.fillText(u,0,0),this.restore(),p+=g+i*(" "==u?2:1)}}}}();var x=l.LineString.prototype._paintOn;l.LineString.include({_paintOn:function(t,e,i,n,s){var a=this.getSymbol();if(a&&a.textPathSize){!function(t){for(var e,i,n=0;n<t.length-1;)e=t[n],i=t[n+1],Math.abs(e.x-i.x)<1e-6&&Math.abs(e.y-i.y)<1e-6?t.splice(n+1,1):n++}(e);var r=this.getMap().getScale(),o=parseInt(a.textPathSize/r);if(o<3||1e3<o)return;var h=(o+="px")+" "+this.options.fontFamily;this._paintPolylineTextPath(t,e,this.options.textName,h,this.options.symbol.lineWidth,i)}else x.apply(this,arguments)},_paintPolylineTextPath:function(t,e,i,n,s,a){t.font=n,t.strokeStyle="rgba(0,0,0,0)",t.lineWidth=0,t.globalAlpha=a,t.textAlign="center",t.textBaseline="middle",t.textOverflow="visible",t.textJustify=!0;for(var r=[],o=e.length,h=0;h<o;h++)r.push(e[h].x),r.push(e[h].y);t.beginPath(),t.moveTo(r[0],r[1]),t.textPath(i,r),l.Canvas._stroke(t,a)}}),"undefined"!=typeof console&&console.log("maptalks.textpath v0.1.0, requires maptalks@>=0.40.0.")});